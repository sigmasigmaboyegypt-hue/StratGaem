<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Country-Building Simulator ‚Äî StratGaem</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg-1: #071029;
            --bg-2: #0f1f3a;
            --glass: rgba(255,255,255,0.04);
            --glass-2: rgba(255,255,255,0.06);
            --card: rgba(255,255,255,0.03);
            --accent: #3da5f5;
            --accent-2: #1f7ed0;
            --accent-3: #6be281;
            --danger: #ff5c5c;
            --muted: rgba(255,255,255,0.75);
            --shadow: 0 8px 30px rgba(2,6,23,0.6);
            --glass-border: rgba(255,255,255,0.04);
            --transition: 220ms cubic-bezier(.2,.9,.2,1);
            --timeline-height: 72px;
        }

        *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0;padding:0;color:var(--muted);}

        html,body{height:100%}
        body{
            min-height:100vh;
            background: linear-gradient(180deg, var(--bg-1) 0%, #062033 35%, #1a2436 100%);
            padding:18px;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        .app {
            max-width:1300px;
            margin:0 auto;
            display:grid;
            grid-template-columns: 320px 1fr;
            gap:18px;
            align-items:start;
        }

        header.app-header{
            grid-column: 1 / -1;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            padding:14px;
            border-radius:12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border: 1px solid var(--glass-border);
            box-shadow:var(--shadow);
            position:sticky;
            top:18px;
            z-index:1200;
        }
        header .left { display:flex; gap:12px; align-items:center; }
        header h1{ font-size:1.05rem; color:#fff; letter-spacing:0.2px; margin-bottom:2px; }
        header p{ font-size:0.85rem; opacity:0.9; margin:0; color:var(--muted); }
        .controls { display:flex; gap:8px; align-items:center; }

        .btn {
            background: linear-gradient(180deg,var(--accent),var(--accent-2));
            color:#052230;
            border:none;
            padding:8px 12px;
            border-radius:10px;
            font-weight:700;
            cursor:pointer;
            box-shadow:0 6px 20px rgba(31,126,208,0.12);
            transition:transform var(--transition), box-shadow var(--transition);
            display:inline-flex;
            gap:8px;
            align-items:center;
            justify-content:center;
        }
        .btn.ghost{ background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted); box-shadow:none; }
        .btn.secondary{ background: linear-gradient(180deg,var(--accent-3), #2fb564); color:#042716; }
        .btn.small{ padding:6px 10px; font-size:0.9rem; border-radius:8px; }
        .btn:hover{ transform: translateY(-3px); }
        .btn:active{ transform: translateY(0); opacity:0.95; }

        .sidebar{
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius:12px;
            padding:12px;
            border:1px solid var(--glass-border);
            box-shadow:var(--shadow);
            height: calc(100vh - 140px);
            overflow:auto;
            position:sticky;
            top:86px;
        }
        .sidebar h3{ color:#fff; font-size:0.95rem; margin-bottom:8px; }
        .stat-list{ display:grid; gap:8px; }
        .stat {
            background: linear-gradient(180deg, rgba(255,255,255,0.018), rgba(255,255,255,0.01));
            padding:10px;
            border-radius:10px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border:1px solid rgba(255,255,255,0.02);
        }
        .stat .meta{ display:flex; gap:8px; flex-direction:column; }
        .stat .value{ font-weight:800; color:#fff; font-size:1.05rem; }

        main { min-height:60vh; display:flex; flex-direction:column; gap:12px; }

        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            padding:12px;
            border-radius:12px;
            border:1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(2,6,23,0.5);
        }

        .selection-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius:10px;
            padding:12px;
            cursor:pointer;
            transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
            border:1px solid transparent;
        }
        .card:hover{ transform:translateY(-6px); box-shadow:0 8px 22px rgba(2,6,23,0.5); }
        .card.selected{ outline: 3px solid rgba(61,165,245,0.14); border-color: rgba(61,165,245,0.12); background: linear-gradient(180deg, rgba(61,165,245,0.02), rgba(61,165,245,0.01)); }

        .country-grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(150px,1fr));
            gap:8px;
            max-height:320px;
            overflow:auto;
            padding:6px;
        }
        .country-item{ padding:8px 10px; border-radius:8px; background: rgba(255,255,255,0.02); cursor:pointer; border:1px solid transparent; }
        .country-item:hover{ transform:translateY(-2px); background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.04); }
        .country-item.selected{ background: linear-gradient(90deg, rgba(61,165,245,0.07), rgba(61,165,245,0.03)); border-color: rgba(61,165,245,0.14); color:#fff; }

        .actions { display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
        .action-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); }
        .action-item .left{ display:flex; gap:8px; align-items:center; }
        .action-item .cost{ font-weight:800; color:var(--danger); margin-left:8px; }

        .event-container{
            position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column-reverse; gap:10px; z-index:1400; pointer-events:none;
        }
        .event-modal{ pointer-events:auto; width:360px; max-width:92vw; padding:12px; border-radius:12px; background:linear-gradient(180deg,#0b2a3a,#08202b); color:var(--muted); border:1px solid rgba(255,255,255,0.04); box-shadow:0 20px 60px rgba(2,6,23,0.6); transform:translateY(10px) scale(.98); opacity:0; transition: all 260ms cubic-bezier(.2,.9,.2,1); }
        .event-modal.active{ opacity:1; transform:translateY(0) scale(1); }
        .event-modal.major{ background: linear-gradient(180deg,#3f0f14,#5c151a); color:#fff; border:1px solid rgba(255,100,100,0.18); }

        .center-modal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.98); width:680px; max-width:96%; z-index:1500; background:linear-gradient(180deg,#071725,#092233); color:var(--muted); padding:18px; border-radius:12px; box-shadow:0 30px 80px rgba(2,6,23,0.85); opacity:0; pointer-events:none; transition: all 240ms cubic-bezier(.2,.9,.2,1); }
        .center-modal.active{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1); }
        .center-modal h3{ color:#fff; margin-bottom:8px; }

        /* Timeline UI */
        .timeline {
            height: var(--timeline-height);
            display:flex;
            align-items:center;
            gap:12px;
            padding:8px;
            border-radius:10px;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
            border:1px solid rgba(255,255,255,0.02);
            box-shadow: 0 8px 20px rgba(2,6,23,0.4);
        }
        .timeline .info { min-width:220px; display:flex; flex-direction:column; gap:6px; }
        .timeline .info .era { font-weight:700; color:#fff; font-size:0.95rem; }
        .timeline .info .year { font-weight:600; color:var(--muted); font-size:0.9rem; }

        .timeline .track { flex:1; height:28px; position:relative; display:flex; align-items:center; gap:8px; }
        .timeline .track input[type="range"]{ width:100%; appearance:none; height:6px; background:linear-gradient(90deg,var(--accent) 0%,var(--accent-2) 100%); border-radius:6px; outline:none; }
        .timeline .track input[type="range"]::-webkit-slider-thumb{ appearance:none; width:18px; height:18px; border-radius:999px; background:#fff; box-shadow:0 4px 12px rgba(2,6,23,0.5); border:3px solid var(--accent-2); margin-top:-6px; cursor:pointer; }
        .timeline .controls { display:flex; gap:8px; align-items:center; min-width:140px; justify-content:flex-end; }

        /* small progress chips for stat bars in nation management */
        .stat-bar { height:10px; background:rgba(255,255,255,0.04); border-radius:6px; overflow:hidden; }
        .stat-bar .fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0%; transition:width 420ms cubic-bezier(.2,.9,.2,1); }

        @media (max-width:980px){
            .app{ grid-template-columns: 1fr; padding-bottom:80px; }
            .sidebar{ position:relative; height:auto; top:auto; }
            header.app-header{ position:sticky; top:0; border-radius:0 0 12px 12px; }
            .timeline { flex-direction:column; align-items:flex-start; gap:6px; height:auto; }
            .timeline .controls{ width:100%; justify-content:space-between; }
        }

        .muted{ opacity:0.9; color:var(--muted); font-size:0.9rem; }
        .title-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .subtle{ opacity:0.86; font-size:0.9rem; }
        .small{ font-size:0.9rem; padding:6px 10px; border-radius:8px; }
        .card:focus, .country-item:focus, .btn:focus { outline: 3px solid rgba(61,165,245,.12); outline-offset:2px; }
    </style>
</head>
<body>
    <div class="app" id="app-root">
        <header class="app-header" role="banner" aria-label="Game header">
            <div style="display:flex; gap:12px; align-items:center;">
                <div>
                    <h1>Country-Building Simulator</h1>
                    <p class="subtle" id="header-sub">Build your nation ‚Äî Turn: <strong id="turn-counter">1</strong></p>
                </div>
            </div>

            <div class="controls" role="region" aria-label="Game controls">
                <select id="timeline-select" class="small" title="Choose historical timeline" aria-label="Timeline select">
                    <option value="WWII">World War II (1939‚Äì1945)</option>
                    <option value="ColdWar">Cold War (1947‚Äì1991)</option>
                    <option value="Modern">Modern Day (1991‚Äìpresent)</option>
                </select>

                <button id="next-turn" class="btn small" title="Advance to next turn" aria-label="Next turn">‚ñ∂ Next Turn</button>

                <button id="save-btn" class="btn ghost small" title="Save the game">üíæ Save</button>
                <button id="load-btn" class="btn ghost small" title="Load last save">üìÇ Load</button>
            </div>
        </header>

        <!-- Timeline UI (new design) -->
        <div style="grid-column:1 / -1; margin-top:12px;">
            <div class="timeline panel" role="region" aria-label="Timeline control">
                <div class="info">
                    <div class="era" id="timeline-era">Era: WWII</div>
                    <div class="year" id="timeline-year">1939</div>
                </div>

                <div class="track" aria-hidden="false" title="Drag to change year">
                    <input id="timeline-range" type="range" min="0" max="100" value="0" aria-label="Timeline slider" />
                    <!-- event markers area (visual only) -->
                    <div id="timeline-markers" style="position:absolute; left:0; right:0; top:-8px; height:40px; pointer-events:none;"></div>
                </div>

                <div class="controls">
                    <button id="timeline-play" class="btn small" title="Play timeline">Play ‚ñ∂</button>
                    <button id="timeline-fast" class="btn ghost small" title="Fast forward">√ó2</button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Nation stats">
            <h3>Nation Dashboard</h3>
            <div class="stat-list" id="stat-list">
                <div class="stat">
                    <div class="meta"><div class="muted">Country</div><div id="country-name-display">Unselected</div></div>
                    <div class="value" id="money-value">$1000</div>
                </div>

                <div class="stat">
                    <div class="meta"><div class="muted">Population</div><div id="population-value">1.2M</div></div>
                    <div class="value" id="stability-value">75%</div>
                </div>

                <div class="stat">
                    <div class="meta"><div class="muted">Technology</div><div id="tech-value">25</div></div>
                    <div class="value" id="minerals-value">500</div>
                </div>

                <div class="stat">
                    <div class="meta"><div class="muted">Military</div><div id="military-value">0</div></div>
                    <div class="value" id="influence-value">10</div>
                </div>

                <div class="stat">
                    <div class="meta"><div class="muted">Diplomacy Rep</div><div id="diplo-value">0</div></div>
                    <div class="value" id="turn-count-small">Turn 1</div>
                </div>

                <div style="margin-top:12px;">
                    <button id="export-btn" class="btn ghost small" style="width:100%;">Export Save</button>
                    <button id="import-btn" class="btn ghost small" style="width:100%; margin-top:8px;">Import Save</button>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main role="main" aria-live="polite">
            <section id="continent-phase" class="panel" aria-label="Continent selection">
                <div class="title-row">
                    <h3>Choose Your Continent</h3>
                    <div class="muted">Pick wisely ‚Äî bonuses apply</div>
                </div>

                <p class="subtle" style="margin-top:8px;">Hover or tap info for bonuses.</p>

                <div class="selection-grid" id="continent-grid" style="margin-top:10px;">
                    <div class="card" tabindex="0" data-continent="africa" role="button">
                        <div style="font-size:22px">üåç Africa</div>
                        <div class="muted" style="margin-top:6px">+50% mineral production, -20% initial infrastructure</div>
                    </div>
                    <div class="card" tabindex="0" data-continent="asia" role="button">
                        <div style="font-size:22px">üóæ Asia</div>
                        <div class="muted" style="margin-top:6px">+30% population growth, +20% tech research speed</div>
                    </div>
                    <div class="card" tabindex="0" data-continent="europe" role="button">
                        <div style="font-size:22px">üèõÔ∏è Europe</div>
                        <div class="muted" style="margin-top:6px">+40% initial infrastructure, -10% resource production</div>
                    </div>
                    <div class="card" tabindex="0" data-continent="north-america" role="button">
                        <div style="font-size:22px">üóΩ North America</div>
                        <div class="muted" style="margin-top:6px">+30% money generation, +15% trade efficiency</div>
                    </div>
                    <div class="card" tabindex="0" data-continent="south-america" role="button">
                        <div style="font-size:22px">üå¥ South America</div>
                        <div class="muted" style="margin-top:6px">+40% food production, +25% natural resources</div>
                    </div>
                    <div class="card" tabindex="0" data-continent="oceania" role="button">
                        <div style="font-size:22px">üèùÔ∏è Oceania</div>
                        <div class="muted" style="margin-top:6px">+50% stability, +30% diplomatic power</div>
                    </div>
                </div>

                <div style="text-align:right; margin-top:12px;">
                    <button id="next-to-country" class="btn small" disabled>Continue ‚Üí</button>
                </div>
            </section>

            <section id="country-phase" class="panel" aria-label="Country selection" hidden>
                <div class="title-row">
                    <h3>Choose Your Country</h3>
                    <div class="muted" id="selected-continent-name">From selected continent</div>
                </div>

                <p class="subtle" style="margin-top:6px">Tap a country to select it.</p>

                <div class="country-grid" id="country-grid" style="margin-top:10px;"></div>

                <div style="text-align:right; margin-top:12px;">
                    <button id="next-to-politics" class="btn small" disabled>Continue ‚Üí</button>
                </div>
            </section>

            <section id="politics-phase" class="panel" aria-label="Political system selection" hidden>
                <div class="title-row">
                    <h3>Choose Political System</h3>
                    <div class="muted">This shapes bonuses & events</div>
                </div>

                <div class="selection-grid" id="politics-grid" style="margin-top:10px;">
                    <div class="card" data-system="capitalist" tabindex="0" role="button">
                        <div style="font-size:20px">üíº Capitalist</div>
                        <div class="muted" style="margin-top:6px">+25% money, -15% stability</div>
                    </div>
                    <div class="card" data-system="socialist" tabindex="0" role="button">
                        <div style="font-size:20px">‚öñÔ∏è Socialist</div>
                        <div class="muted" style="margin-top:6px">+30% stability, -20% economic growth</div>
                    </div>
                    <div class="card" data-system="mixed" tabindex="0" role="button">
                        <div style="font-size:20px">üîÑ Mixed</div>
                        <div class="muted" style="margin-top:6px">Balanced bonuses</div>
                    </div>
                </div>

                <div style="text-align:right; margin-top:12px;">
                    <button id="next-to-game" class="btn small" disabled>Start ‚Üí</button>
                </div>
            </section>

            <section id="game-phase" class="panel" aria-label="Main game" hidden>
                <div class="title-row">
                    <h3>Nation Management</h3>
                    <div class="muted">Use actions to grow your country</div>
                </div>

                <div style="margin-top:10px;">
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <div style="flex:1 1 320px;">
                            <h4 style="margin:0 0 8px 0">Overview</h4>
                            <div style="display:grid; gap:8px;">
                                <div style="display:flex; align-items:center; justify-content:space-between;">
                                    <div style="flex:1; margin-right:12px;">
                                        <div class="muted">Money</div>
                                        <div class="stat-bar" aria-hidden="true"><div id="money-fill" class="fill" style="width:40%"></div></div>
                                    </div>
                                    <div style="min-width:80px; text-align:right; font-weight:700;" id="money-value-compact">$1000</div>
                                </div>

                                <div style="display:flex; align-items:center; justify-content:space-between;">
                                    <div style="flex:1; margin-right:12px;">
                                        <div class="muted">Population</div>
                                        <div class="stat-bar"><div id="pop-fill" class="fill" style="width:40%"></div></div>
                                    </div>
                                    <div style="min-width:80px; text-align:right; font-weight:700;" id="population-value-compact">1.2M</div>
                                </div>

                                <div style="display:flex; align-items:center; justify-content:space-between;">
                                    <div style="flex:1; margin-right:12px;">
                                        <div class="muted">Technology</div>
                                        <div class="stat-bar"><div id="tech-fill" class="fill" style="width:15%"></div></div>
                                    </div>
                                    <div style="min-width:80px; text-align:right; font-weight:700;" id="tech-value-compact">25</div>
                                </div>
                            </div>
                        </div>

                        <div style="flex:1 1 520px;">
                            <h4 style="margin:0 0 8px 0">Actions</h4>
                            <div class="actions" id="action-panel">
                                <!-- populated in HTML earlier; kept for layout -->
                                <div class="panel" style="padding:10px;">
                                    <h4 style="margin:0 0 8px 0">Economy</h4>
                                    <div class="action-item">
                                        <div class="left"><div>Build Factory</div></div>
                                        <div><button class="btn small" data-action="factory">Build <span class="cost" data-action="factory">$500</span></button></div>
                                    </div>
                                    <div class="action-item" style="margin-top:8px">
                                        <div class="left"><div>Develop Infrastructure</div></div>
                                        <div><button class="btn small" data-action="infrastructure">Develop <span class="cost" data-action="infrastructure">$300</span></button></div>
                                    </div>
                                    <div class="action-item" style="margin-top:8px">
                                        <div class="left"><div>Trade Agreement</div></div>
                                        <div><button class="btn small" data-action="trade">Negotiate <span class="cost" data-action="trade">$200</span></button></div>
                                    </div>
                                </div>

                                <div class="panel" style="padding:10px;">
                                    <h4 style="margin:0 0 8px 0">Society</h4>
                                    <div class="action-item">
                                        <div class="left"><div>Education Reform</div></div>
                                        <div><button class="btn small" data-action="education">Reform <span class="cost" data-action="education">$400</span></button></div>
                                    </div>
                                    <div class="action-item" style="margin-top:8px">
                                        <div class="left"><div>Healthcare System</div></div>
                                        <div><button class="btn small" data-action="healthcare">Implement <span class="cost" data-action="healthcare">$600</span></button></div>
                                    </div>
                                    <div class="action-item" style="margin-top:8px">
                                        <div class="left"><div>Social Programs</div></div>
                                        <div><button class="btn small" data-action="social">Fund <span class="cost" data-action="social">$250</span></button></div>
                                    </div>
                                </div>

                                <div class="panel" style="padding:10px;">
                                    <h4 style="margin:0 0 8px 0">Military & Diplomacy</h4>
                                    <div class="action-item">
                                        <div class="left"><div>Build Barracks</div></div>
                                        <div><button class="btn small" data-action="barracks">Build <span class="cost" data-action="barracks">$700</span></button></div>
                                    </div>
                                    <div class="action-item" style="margin-top:8px">
                                        <div class="left"><div>Recruit Division</div></div>
                                        <div><button class="btn small" data-action="recruit">Recruit <span class="cost" data-action="recruit">$500</span></button></div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="mobile-actionbar" aria-hidden="false" style="display:none;">
        <button id="mobile-next" class="btn small">Next Turn</button>
        <button id="mobile-save" class="btn ghost small">Save</button>
        <button id="mobile-open" class="btn ghost small">Menu</button>
    </div>

    <div class="event-container" id="event-container" aria-live="polite"></div>

    <div id="center-modal" class="center-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <h3 id="center-title">Title</h3>
        <p id="center-body">Body</p>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button id="center-close" class="btn ghost small">Close</button>
            <button id="center-restart" class="btn secondary small">Play Again</button>
        </div>
    </div>

    <script>
        /**************************************************************************
         * UI fixes to Nation Management + new Timeline UI
         *
         * What I changed:
         * - Added a horizontal Timeline control (range slider + play/fast controls)
         * - Connected timeline to gameState.timelineEra & timelineYear
         * - Improved nation management overview with stat bars and compact values
         * - Kept action logic and enhanced UI refresh to animate stat-bar fills
         * - Timeline supports play/pause, scrubbing, and fast-forward multiplier
         **************************************************************************/

        const DEFAULT_STATE = {
            continent: null, country: null, politicalSystem: null,
            money: 1000, population: 1200000, technology: 25,
            minerals: 500, stability: 75, influence: 10,
            militaryPower: 0, manpower: 300000, diplomacyReputation: 0,
            turn: 1, timelineEra: 'WWII', timelineYear: 1939,
            timelinePlaying: false, timelineSpeed: 1,
            buildings: { factory:0, infrastructure:0, research:0, mine:0, barracks:0 },
            modifiers: { money:1, population:1, technology:1, minerals:1, stability:1, influence:1 },
            scaledCosts: {}, eventQueue: [], flags: {}, allies: [], enemies: [], isInWar:false
        };

        let gameState = JSON.parse(JSON.stringify(DEFAULT_STATE));

        const COUNTRIES_BY_CONTINENT = {
            europe: ["France","United Kingdom","Germany","Italy","Spain","Poland","Netherlands","Belgium","Sweden","Norway","Denmark","Finland","Austria","Switzerland","Portugal","Greece"],
            asia: ["Japan","China","India","South Korea","North Korea","Vietnam","Thailand","Philippines","Indonesia","Malaysia","Singapore","Pakistan","Bangladesh","Sri Lanka","Myanmar","Cambodia"],
            africa: ["Egypt","South Africa","Nigeria","Kenya","Ethiopia","Ghana","Tanzania","Uganda","Morocco","Algeria","Sudan","Angola","Mozambique","Zambia","Zimbabwe","Senegal"],
            'north-america': ["United States","Canada","Mexico","Cuba","Jamaica","Haiti","Dominican Republic","Guatemala","Honduras","El Salvador","Nicaragua","Costa Rica","Panama"],
            'south-america': ["Brazil","Argentina","Chile","Colombia","Peru","Venezuela","Ecuador","Bolivia","Paraguay","Uruguay","Guyana","Suriname","French Guiana"],
            oceania: ["Australia","New Zealand","Papua New Guinea","Fiji","Solomon Islands","Vanuatu","New Caledonia","Samoa","Tonga","Kiribati","Micronesia","Palau"]
        };

        const BASE_COSTS = {
            factory:500, infrastructure:300, trade:200,
            education:400, healthcare:600, social:250,
            research:800, techedu:350, innovation:450,
            mine:400, agriculture:300, resourcetrade:150,
            barracks:700, recruit:500, spy:300,
            ally:200, offer_trade:150, sanction:100
        };
        const COST_SCALE = { factory:1.18, infrastructure:1.12, trade:1.08, education:1.15, healthcare:1.18, social:1.10, research:1.2, techedu:1.12, innovation:1.14, mine:1.15, agriculture:1.12, resourcetrade:1.06, barracks:1.20, recruit:1.25, spy:1.15, ally:1.10, offer_trade:1.08, sanction:1.05 };

        const continentBonuses = {
            africa: { minerals:1.5, infrastructure:0.8 },
            asia: { population:1.3, technology:1.2 },
            europe: { infrastructure:1.4, minerals:0.9 },
            'north-america': { money:1.3, influence:1.15 },
            'south-america': { minerals:1.25, stability:1.1 },
            oceania: { stability:1.5, influence:1.3 }
        };
        const politicalBonuses = {
            capitalist: { money:1.25, stability:0.85 },
            socialist: { stability:1.3, money:0.8 },
            mixed: { money:1.1, stability:1.1, technology:1.05, minerals:1.05 }
        };

        const actionEffects = {
            factory:{ moneyMod:1.1, buildings:{factory:1} },
            infrastructure:{ stability:5, population:50000, buildings:{infrastructure:1} },
            trade:{ moneyMod:1.05, influence:2 },
            education:{ technology:10, stability:3 },
            healthcare:{ stability:10, population:100000 },
            social:{ stability:8 },
            research:{ technology:25, buildings:{research:1} },
            techedu:{ technology:15 },
            innovation:{ technology:20 },
            mine:{ minerals:200, buildings:{mine:1} },
            agriculture:{ population:75000, stability:3 },
            resourcetrade:{ money:300, minerals:-50 },
            barracks:{ militaryPower:30, buildings:{barracks:1} },
            recruit:{ money:-200, militaryPower:80, manpower:-20000 },
            spy:{ diplomacyReputation:-4, technology:5 },
            ally:{ influence:6 },
            offer_trade:{ money:150, influence:2 },
            sanction:{ influence:-6, money:-100 }
        };

        const EVENTS = [
            { id:'natural_disaster', title:'Natural Disaster', description:'A severe natural disaster struck.', era:'Modern', yearRange:[1990,2030], option1:'Send emergency funds', option2:'Ask for aid', effects1:{money:-300,stability:-5}, effects2:{stability:-10,influence:-2} },
            { id:'pandemic', title:'Pandemic', description:'A global pandemic spreads fast.', era:'Modern', yearRange:[2020,2025], option1:'Lockdown', option2:'Keep open', effects1:{money:-800,population:-50000,stability:5}, effects2:{money:200,population:-150000,stability:-8} }
        ];

        // DOM
        const DOM = {
            continentCards: document.querySelectorAll('[data-continent]'),
            nextToCountryBtn: document.getElementById('next-to-country'),
            countryPhase: document.getElementById('country-phase'),
            continentPhase: document.getElementById('continent-phase'),
            countryGrid: document.getElementById('country-grid'),
            selectedContinentName: document.getElementById('selected-continent-name'),
            nextToPoliticsBtn: document.getElementById('next-to-politics'),
            politicsPhase: document.getElementById('politics-phase'),
            politicsCards: document.querySelectorAll('[data-system]'),
            nextToGameBtn: document.getElementById('next-to-game'),
            gamePhase: document.getElementById('game-phase'),
            actionButtons: document.querySelectorAll('[data-action]'),
            costSpans: document.querySelectorAll('.cost[data-action]'),
            eventContainer: document.getElementById('event-container'),
            centerModal: document.getElementById('center-modal'),
            centerTitle: document.getElementById('center-title'),
            centerBody: document.getElementById('center-body'),
            centerClose: document.getElementById('center-close'),
            centerRestart: document.getElementById('center-restart'),
            saveBtn: document.getElementById('save-btn'),
            loadBtn: document.getElementById('load-btn'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            headerSub: document.getElementById('header-sub'),
            turnCounter: document.getElementById('turn-counter'),
            timelineSelect: document.getElementById('timeline-select'),
            timelineEra: document.getElementById('timeline-era'),
            timelineYear: document.getElementById('timeline-year'),
            timelineRange: document.getElementById('timeline-range'),
            timelinePlay: document.getElementById('timeline-play'),
            timelineFast: document.getElementById('timeline-fast'),
            timelineMarkers: document.getElementById('timeline-markers'),
            countryNameDisplay: document.getElementById('country-name-display'),
            moneyValue: document.getElementById('money-value'),
            populationValue: document.getElementById('population-value'),
            techValue: document.getElementById('tech-value'),
            mineralsValue: document.getElementById('minerals-value'),
            stabilityValue: document.getElementById('stability-value'),
            influenceValue: document.getElementById('influence-value'),
            militaryValue: document.getElementById('military-value'),
            diploValue: document.getElementById('diplo-value'),
            nextTurnBtn: document.getElementById('next-turn'),
            moneyFill: document.getElementById('money-fill'),
            popFill: document.getElementById('pop-fill'),
            techFill: document.getElementById('tech-fill'),
            moneyCompact: document.getElementById('money-value-compact'),
            populationCompact: document.getElementById('population-value-compact'),
            techCompact: document.getElementById('tech-value-compact'),
            mobileNext: document.getElementById('mobile-next'),
            mobileSave: document.getElementById('mobile-save')
        };

        function formatNumber(n){
            if (Math.abs(n) >= 1000000) return (n/1000000).toFixed(1) + 'M';
            if (Math.abs(n) >= 1000) return (n/1000).toFixed(1) + 'k';
            return n.toString();
        }

        function safeGetCost(action){
            return Math.max(1, Math.round(gameState.scaledCosts[action] || BASE_COSTS[action] || 0));
        }

        const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
        function playClickTone(){
            if (!audioCtx) return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = 'sine'; o.frequency.value = 440; g.gain.value = 0.02;
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.06);
        }

        const STORAGE_KEY = 'stratgaem_v3_timeline';
        function saveGame(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); showCenterModal('Saved','Game saved locally.'); } catch(e){ showCenterModal('Save Failed','Saving failed.'); } }
        function loadGame(){ try { const raw = localStorage.getItem(STORAGE_KEY); if (!raw) { showCenterModal('No Save','No save found'); return; } gameState = Object.assign({}, DEFAULT_STATE, JSON.parse(raw)); initAfterLoad(); showCenterModal('Loaded','Save loaded.'); } catch(e){ showCenterModal('Load Error','Failed to load save.'); } }
        function exportSave(){ const data = JSON.stringify(gameState, null, 2); const blob = new Blob([data], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'stratgaem_save.json'; a.click(); URL.revokeObjectURL(url); }
        function importSave(){ const input = document.createElement('input'); input.type='file'; input.accept='.json,application/json'; input.onchange = e=>{ const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ()=>{ try { gameState = Object.assign({}, DEFAULT_STATE, JSON.parse(r.result)); initAfterLoad(); showCenterModal('Imported','Save imported.'); } catch(err){ showCenterModal('Import Error','Invalid JSON.'); } }; r.readAsText(f); }; input.click(); }

        function showCenterModal(title, body, autoClose=false){ DOM.centerTitle.textContent = title; DOM.centerBody.textContent = body; DOM.centerModal.classList.add('active'); DOM.centerModal.setAttribute('aria-hidden','false'); playClickTone(); if (autoClose) setTimeout(hideCenterModal, 1200); }
        function hideCenterModal(){ DOM.centerModal.classList.remove('active'); DOM.centerModal.setAttribute('aria-hidden','true'); }

        function initializeScaledCosts(){ gameState.scaledCosts = gameState.scaledCosts || {}; Object.keys(BASE_COSTS).forEach(k=> { if (!gameState.scaledCosts[k]) gameState.scaledCosts[k] = BASE_COSTS[k]; }); }

        function applyBonuses(){ Object.keys(gameState.modifiers).forEach(k=> gameState.modifiers[k]=1); if (gameState.continent && continentBonuses[gameState.continent]) Object.keys(continentBonuses[gameState.continent]).forEach(k=> gameState.modifiers[k]*=continentBonuses[gameState.continent][k]); if (gameState.politicalSystem && politicalBonuses[gameState.politicalSystem]) Object.keys(politicalBonuses[gameState.politicalSystem]).forEach(k=> gameState.modifiers[k]*=politicalBonuses[gameState.politicalSystem][k]); }

        function renderCountries(continent){
            DOM.countryGrid.innerHTML = '';
            const list = COUNTRIES_BY_CONTINENT[continent] || [];
            list.forEach(name=> {
                const el = document.createElement('div');
                el.className = 'country-item';
                el.tabIndex = 0;
                el.textContent = name;
                el.dataset.country = name;
                el.addEventListener('click', ()=> {
                    document.querySelectorAll('.country-item').forEach(c=>c.classList.remove('selected'));
                    el.classList.add('selected');
                    gameState.country = name;
                    DOM.nextToPoliticsBtn.disabled = false;
                    DOM.countryNameDisplay.textContent = name;
                    playClickTone();
                });
                el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') el.click(); });
                DOM.countryGrid.appendChild(el);
            });
        }

        function refreshCostsAndButtons(){
            document.querySelectorAll('.cost[data-action]').forEach(span=>{
                const act = span.getAttribute('data-action');
                const cost = safeGetCost(act);
                span.textContent = `$${cost}`;
            });
            document.querySelectorAll('button[data-action]').forEach(btn=>{
                const act = btn.dataset.action;
                btn.disabled = (gameState.money < safeGetCost(act));
            });
        }

        function performAction(action){
            const cost = safeGetCost(action);
            if (gameState.money < cost){ showCenterModal('Not enough money','You need more money to perform this action.'); return; }
            gameState.money -= cost;
            const eff = actionEffects[action];
            if (eff){
                if (eff.moneyMod) gameState.money = Math.round(gameState.money * eff.moneyMod);
                if (eff.population) gameState.population = Math.max(0, Math.round(gameState.population + eff.population));
                if (eff.technology) gameState.technology = Math.max(0, Math.round(gameState.technology + eff.technology));
                if (eff.minerals) gameState.minerals = Math.max(0, Math.round(gameState.minerals + eff.minerals));
                if (eff.stability) gameState.stability = Math.max(0, Math.min(100, gameState.stability + eff.stability));
                if (eff.influence) gameState.influence = Math.max(0, gameState.influence + eff.influence);
                if (eff.militaryPower) gameState.militaryPower = Math.max(0, gameState.militaryPower + eff.militaryPower);
                if (eff.diplomacyReputation) gameState.diplomacyReputation = Math.round((gameState.diplomacyReputation || 0) + eff.diplomacyReputation);
                if (eff.manpower) gameState.manpower = Math.max(0, (gameState.manpower || 0) + eff.manpower);
                if (eff.buildings) Object.keys(eff.buildings).forEach(b=> gameState.buildings[b] = (gameState.buildings[b]||0) + eff.buildings[b]);
            }
            if (COST_SCALE[action]) gameState.scaledCosts[action] = Math.round((gameState.scaledCosts[action] || BASE_COSTS[action]) * COST_SCALE[action]);
            refreshCostsAndButtons();
            updateUI();
            playClickTone();
        }

        function pushEvent(evt){ gameState.eventQueue.push(evt); renderNextEvent(); }
        function renderNextEvent(){
            if (!gameState.eventQueue.length) return;
            const evt = gameState.eventQueue.shift();
            const modal = document.createElement('div');
            modal.className = 'event-modal' + (evt.isMajor ? ' major' : '');
            modal.innerHTML = `<h4>${evt.title}</h4><p style="margin-top:6px">${evt.description}</p>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
                    <button class="btn small event-opt" data-choice="1">${evt.option1}</button>
                    <button class="btn ghost small event-opt" data-choice="2">${evt.option2}</button>
                </div>`;
            DOM.eventContainer.appendChild(modal);
            requestAnimationFrame(()=> modal.classList.add('active'));
            const opts = modal.querySelectorAll('.event-opt');
            opts.forEach(o=> o.addEventListener('click', ()=>{
                const c = o.dataset.choice;
                const effects = (c === '1') ? (evt.effects1||{}) : (evt.effects2||{});
                applyEffects(effects);
                modal.classList.remove('active');
                setTimeout(()=> modal.remove(), 300);
            }));
            if (!evt.isMajor) setTimeout(()=> { if (modal.parentNode) { modal.classList.remove('active'); setTimeout(()=> modal.remove(),300); } }, 20000);
        }

        function applyEffects(effects){
            if (!effects) return;
            if (effects.money) gameState.money = Math.max(0, Math.round(gameState.money + effects.money));
            if (effects.population) gameState.population = Math.max(0, gameState.population + effects.population);
            if (effects.technology) gameState.technology = Math.max(0, gameState.technology + effects.technology);
            if (effects.minerals) gameState.minerals = Math.max(0, gameState.minerals + effects.minerals);
            if (effects.stability) gameState.stability = Math.max(0, Math.min(100, gameState.stability + effects.stability));
            if (effects.influence) gameState.influence = Math.max(0, gameState.influence + effects.influence);
            if (effects.militaryPower) gameState.militaryPower = Math.max(0, gameState.militaryPower + effects.militaryPower);
            if (effects.isInWar) gameState.isInWar = !!effects.isInWar;
            if (effects.allies && Array.isArray(effects.allies)) gameState.allies = [...new Set([...(gameState.allies||[]), ...effects.allies])];
            if (effects.enemies && Array.isArray(effects.enemies)) gameState.enemies = [...new Set([...(gameState.enemies||[]), ...effects.enemies])];
            updateUI();
        }

        function updateUI(full=false){
            DOM.turnCounter.textContent = gameState.turn;
            DOM.headerSub.textContent = `Era: ${gameState.timelineEra} ‚Ä¢ Year: ${gameState.timelineYear} ‚Ä¢ Turn ${gameState.turn}`;
            DOM.moneyValue.textContent = `$${formatNumber(gameState.money)}`;
            DOM.populationValue.textContent = formatNumber(gameState.population);
            DOM.techValue.textContent = gameState.technology;
            DOM.mineralsValue.textContent = formatNumber(gameState.minerals);
            DOM.stabilityValue.textContent = `${Math.round(gameState.stability)}%`;
            DOM.influenceValue.textContent = gameState.influence;
            DOM.militaryValue.textContent = gameState.militaryPower;
            DOM.diploValue.textContent = gameState.diplomacyReputation || 0;
            DOM.countryNameDisplay.textContent = gameState.country || 'Unselected';
            const smallTurn = document.getElementById('turn-count-small'); if (smallTurn) smallTurn.textContent = `Turn ${gameState.turn}`;

            // compact values
            DOM.moneyCompact && (DOM.moneyCompact.textContent = `$${formatNumber(gameState.money)}`);
            DOM.populationCompact && (DOM.populationCompact.textContent = formatNumber(gameState.population));
            DOM.techCompact && (DOM.techCompact.textContent = gameState.technology);

            // stat bar fills (normalize to reasonable ranges)
            const moneyPct = Math.min(100, Math.round((gameState.money / 5000) * 100));
            const popPct = Math.min(100, Math.round((gameState.population / 5000000) * 100));
            const techPct = Math.min(100, Math.round((gameState.technology / 200) * 100));
            DOM.moneyFill.style.width = moneyPct + '%';
            DOM.popFill.style.width = popPct + '%';
            DOM.techFill.style.width = techPct + '%';

            // timeline UI update
            DOM.timelineEra.textContent = `Era: ${gameState.timelineEra}`;
            DOM.timelineYear.textContent = gameState.timelineYear;

            updateTimelineRange();

            refreshCostsAndButtons();
        }

        // Timeline helpers
        const ERA_RANGES = {
            'WWII': { min: 1939, max: 1945 },
            'ColdWar': { min: 1947, max: 1991 },
            'Modern': { min: 1991, max: 2100 }
        };

        function updateTimelineRange(){
            const era = gameState.timelineEra || 'Modern';
            const rng = ERA_RANGES[era];
            const total = rng.max - rng.min;
            const pct = Math.round(((gameState.timelineYear - rng.min) / Math.max(1, total)) * 100);
            DOM.timelineRange.min = rng.min;
            DOM.timelineRange.max = rng.max;
            DOM.timelineRange.value = gameState.timelineYear;
            // markers: clear & re-add simple major-event markers (if any)
            renderTimelineMarkers(era);
        }

        function renderTimelineMarkers(era){
            const markers = DOM.timelineMarkers;
            markers.innerHTML = '';
            // Add simple markers for known events (static for demo)
            const known = {
                'WWII': [{year:1940,label:'Fall of France'},{year:1941,label:'Pearl Harbor'}],
                'ColdWar': [{year:1961,label:'Berlin Wall'},{year:1962,label:'Cuban Missile'}],
                'Modern': [{year:2001,label:'Terrorism'},{year:2020,label:'Pandemic'}]
            };
            const list = known[era] || [];
            const rng = ERA_RANGES[era];
            list.forEach(k=>{
                const pct = ((k.year - rng.min) / (rng.max - rng.min)) * 100;
                const dot = document.createElement('div');
                dot.style.position = 'absolute';
                dot.style.left = `calc(${pct}% - 6px)`;
                dot.style.top = '6px';
                dot.style.width = '12px';
                dot.style.height = '12px';
                dot.style.borderRadius = '99px';
                dot.style.background = 'rgba(255,255,255,0.9)';
                dot.style.boxShadow = '0 2px 6px rgba(0,0,0,0.6)';
                dot.title = `${k.year}: ${k.label}`;
                markers.appendChild(dot);
            });
        }

        let timelineInterval = null;
        function timelinePlayToggle(){
            gameState.timelinePlaying = !gameState.timelinePlaying;
            DOM.timelinePlay.textContent = gameState.timelinePlaying ? 'Pause ‚è∏' : 'Play ‚ñ∂';
            if (gameState.timelinePlaying){
                timelineInterval = setInterval(()=> {
                    advanceTimelineYear(1 * gameState.timelineSpeed);
                }, 800 / gameState.timelineSpeed);
            } else {
                clearInterval(timelineInterval); timelineInterval = null;
            }
        }

        function advanceTimelineYear(delta){
            const era = gameState.timelineEra;
            const rng = ERA_RANGES[era];
            gameState.timelineYear = Math.min(rng.max, Math.max(rng.min, gameState.timelineYear + delta));
            // optional: push era-specific major event on particular years
            if (Math.random() < 0.05) pushEvent(EVENTS[Math.floor(Math.random()*EVENTS.length)]);
            updateUI();
        }

        // Wire timeline interactions
        function setupTimelineControls(){
            DOM.timelineRange.addEventListener('input', (e) => {
                gameState.timelineYear = parseInt(e.target.value, 10);
                updateUI();
            });
            DOM.timelinePlay.addEventListener('click', () => {
                timelinePlayToggle();
                playClickTone();
            });
            DOM.timelineFast.addEventListener('click', () => {
                gameState.timelineSpeed = gameState.timelineSpeed === 1 ? 2 : 1;
                DOM.timelineFast.textContent = gameState.timelineSpeed === 2 ? '√ó2' : '√ó1';
                playClickTone();
                if (gameState.timelinePlaying){
                    clearInterval(timelineInterval);
                    timelineInterval = setInterval(()=> advanceTimelineYear(1 * gameState.timelineSpeed), 800 / gameState.timelineSpeed);
                }
            });
            DOM.timelineSelect.addEventListener('change', (e)=> {
                const v = e.target.value;
                gameState.timelineEra = v === 'Modern' ? 'Modern' : (v === 'ColdWar' ? 'ColdWar' : 'WWII');
                gameState.timelineYear = (gameState.timelineEra === 'WWII') ? 1939 : (gameState.timelineEra === 'ColdWar') ? 1947 : 1991;
                updateUI();
            });
        }

        function refreshCostsAndButtons(){
            document.querySelectorAll('.cost[data-action]').forEach(span=>{
                const act = span.getAttribute('data-action');
                const cost = safeGetCost(act);
                span.textContent = `$${cost}`;
            });
            document.querySelectorAll('button[data-action]').forEach(btn=>{
                const act = btn.dataset.action;
                btn.disabled = (gameState.money < safeGetCost(act));
            });
        }

        function nextTurn(){
            gameState.turn += 1;
            // year progression by turn (keeps timeline in sync)
            const era = gameState.timelineEra;
            const rng = ERA_RANGES[era];
            gameState.timelineYear = Math.min(rng.max, gameState.timelineYear + 1);

            const moneyGain = Math.round(120 * (gameState.modifiers.money||1));
            gameState.money += moneyGain;
            const popGain = Math.round(Math.max(1000, (gameState.population * 0.01) * ((gameState.modifiers.population||1)-1 + 1)));
            gameState.population += Math.round(popGain * 0.05);
            gameState.technology += Math.round(1 * (gameState.modifiers.technology||1));
            gameState.minerals += Math.round(10 * (gameState.modifiers.minerals||1));
            gameState.stability = Math.max(0, Math.min(100, gameState.stability - (Math.random()*1.2)));
            if (Math.random() < 0.22) {
                const possible = EVENTS.filter(e => e.era === gameState.timelineEra || e.era === 'Modern');
                const evt = possible[Math.floor(Math.random() * possible.length)];
                if (evt) pushEvent(Object.assign({}, evt));
            }
            updateUI();
            playClickTone();
        }

        // Flow wiring
        function setupFlows(){
            document.querySelectorAll('[data-continent]').forEach(card=>{
                card.addEventListener('click', ()=>{
                    document.querySelectorAll('[data-continent]').forEach(c=>c.classList.remove('selected'));
                    card.classList.add('selected');
                    const cont = card.dataset.continent;
                    gameState.continent = cont;
                    DOM.nextToCountryBtn.disabled = false;
                    DOM.selectedContinentName.textContent = cont.replace('-', ' ').toUpperCase();
                    renderCountries(cont);
                    initializeScaledCosts();
                    playClickTone();
                });
            });

            DOM.nextToCountryBtn.addEventListener('click', ()=>{
                DOM.continentPhase.hidden = true;
                DOM.countryPhase.hidden = false;
                window.scrollTo({top:0,behavior:'smooth'});
            });

            DOM.nextToPoliticsBtn.addEventListener('click', ()=>{
                if (!gameState.country) { showCenterModal('Select a country', 'You must choose a country to continue.'); return; }
                DOM.countryPhase.hidden = true;
                DOM.politicsPhase.hidden = false;
                window.scrollTo({top:0,behavior:'smooth'});
            });

            document.querySelectorAll('[data-system]').forEach(card=>{
                card.addEventListener('click', ()=>{
                    document.querySelectorAll('[data-system]').forEach(c=>c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.politicalSystem = card.dataset.system;
                    DOM.nextToGameBtn.disabled = false;
                    applyBonuses();
                    playClickTone();
                });
            });

            DOM.nextToGameBtn.addEventListener('click', ()=>{
                DOM.politicsPhase.hidden = true;
                DOM.gamePhase.hidden = false;
                initializeScaledCosts();
                applyBonuses();
                updateUI(true);
                window.scrollTo({top:0,behavior:'smooth'});
            });

            document.querySelectorAll('button[data-action]').forEach(btn=>{
                btn.addEventListener('click', ()=> performAction(btn.dataset.action));
            });
        }

        function setupControls(){
            DOM.nextTurnBtn.addEventListener('click', nextTurn);
            DOM.mobileNext && DOM.mobileNext.addEventListener('click', ()=> DOM.nextTurnBtn.click());
            DOM.mobileSave && DOM.mobileSave.addEventListener('click', saveGame);
            DOM.saveBtn.addEventListener('click', saveGame);
            DOM.loadBtn.addEventListener('click', loadGame);
            DOM.exportBtn.addEventListener('click', exportSave);
            DOM.importBtn.addEventListener('click', importSave);
            DOM.centerClose.addEventListener('click', hideCenterModal);
            DOM.centerRestart.addEventListener('click', ()=>{
                gameState = JSON.parse(JSON.stringify(DEFAULT_STATE));
                initAfterLoad();
                hideCenterModal();
            });
            window.addEventListener('keydown', (e)=>{
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){ e.preventDefault(); saveGame(); }
                if (e.key === ' ') { e.preventDefault(); nextTurn(); }
            });
        }

        function initAfterLoad(){
            initializeScaledCosts();
            applyBonuses();
            updateUI(true);
            // ensure timeline UI consistent
            updateTimelineRange();
        }

        function start(){
            initializeScaledCosts();
            setupFlows();
            setupControls();
            setupTimelineControls();
            updateUI(true);
            setTimeout(()=> showCenterModal('Welcome','Timeline added ‚Äî drag the slider or press Play to scrub years. Space = Next Turn ‚Ä¢ Ctrl+S = Save', true), 700);
        }

        start();
    </script>
</body>
</html>
