<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Country-Building Simulator</title>
    <style>
        :root{
            --primary:#3498db;
            --primary-2:#2980b9;
            --secondary:#2ecc71;
            --danger:#e74c3c;
            --warning:#f39c12;
            --dark:#2c3e50;
            --light:#ecf0f1;
            --shadow:0 4px 6px rgba(0,0,0,0.12);
            --glass: rgba(255,255,255,0.06);
            --transition: all 0.28s ease;
            --glass-2: rgba(255,255,255,0.12);
        }

        *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:var(--light);}

        body{
            min-height:100vh;
            padding:16px;
            background: linear-gradient(135deg,#0f172a 0%, #1a2a6c 30%, #641e16 70%, #fdbb2d 100%);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            position:relative;
            overflow-x:hidden;
        }

        /* subtle animated clouds */
        .bg-clouds{
            position:fixed;
            top:0;
            left:0;
            right:0;
            height:160px;
            pointer-events:none;
            opacity:0.06;
            z-index:0;
            background-image: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.06) 0 8%, transparent 9%),
                              radial-gradient(circle at 80% 60%, rgba(255,255,255,0.05) 0 10%, transparent 11%);
            animation: drift 40s linear infinite;
        }
        @keyframes drift { from { transform: translateX(-10%);} to { transform: translateX(10%);} }

        .container{max-width:1200px;margin:0 auto;position:relative;z-index:2;}

        header{
            text-align:center;
            margin-bottom:18px;
            padding:16px;
            border-radius:12px;
            background:var(--glass);
            backdrop-filter: blur(6px);
            box-shadow:var(--shadow);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            flex-wrap:wrap;
        }

        header .title {
            text-align:left;
            flex:1 1 360px;
        }
        header h1{font-size:1.5rem;margin-bottom:4px; text-shadow: 1px 1px 2px rgba(0,0,0,0.25);}
        header p{font-size:0.95rem;opacity:0.9;margin-top:4px;}

        .header-controls{
            display:flex;
            gap:8px;
            align-items:center;
            flex:0 0 auto;
        }

        .btn{
            background:var(--primary);
            border:none;
            color:white;
            padding:10px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
            box-shadow:var(--shadow);
            transition:var(--transition);
            display:inline-flex;
            align-items:center;
            gap:8px;
            user-select:none;
        }
        .btn:hover{transform:translateY(-3px);background:var(--primary-2);}
        .btn:active{transform:translateY(0);opacity:0.95;}
        .btn.secondary{background:var(--secondary);color:#05220f;}
        .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);}

        .small{padding:6px 10px;font-size:0.9rem;border-radius:8px;}

        .game-phase{
            display:none;
            background:var(--glass);
            border-radius:12px;
            padding:18px;
            margin-top:14px;
            backdrop-filter: blur(6px);
            box-shadow: var(--shadow);
            transition:var(--transition);
        }
        .game-phase.active{display:block;transform:translateY(0);opacity:1;}

        .selection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:14px;}
        .selection-card{
            background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border-radius:10px;padding:12px;text-align:left;cursor:pointer;border:1px solid transparent;transition:var(--transition);
        }
        .selection-card:hover{transform:translateY(-6px);box-shadow:0 8px 18px rgba(0,0,0,0.25);border-color:rgba(255,255,255,0.06);}
        .selection-card .card-icon{font-size:1.8rem;margin-bottom:8px;}
        .selection-card h3{font-size:1.05rem;margin-bottom:6px;}
        .selection-card p{font-size:0.9rem;opacity:0.9;margin-bottom:6px;}
        .selection-card .tooltip{display:inline-block;margin-left:6px;opacity:0.9;}

        .selection-card.selected{outline:2px solid rgba(52,152,219,0.22);box-shadow:0 8px 20px rgba(52,152,219,0.08);}

        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:14px;}
        .stat-card{background:var(--glass);padding:12px;border-radius:10px;text-align:left;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03);}
        .stat-card h3{font-size:0.95rem;margin-bottom:6px;}
        .stat-value{font-size:1.45rem;font-weight:700;}
        .progress-bar{height:10px;background:rgba(255,255,255,0.06);border-radius:6px;margin-top:10px;overflow:hidden;}
        .progress-fill{height:100%;background:var(--secondary);width:0;transition:width 700ms cubic-bezier(.2,.9,.2,1);}

        .action-panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px;}
        .action-card{background:var(--glass);padding:12px;border-radius:10px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03);}
        .action-card h3{margin-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.03);padding-bottom:8px;}
        .action-item{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02);}
        .action-item:last-child{border-bottom:none;}
        .action-item .cost{font-weight:700;color:var(--warning);margin-left:8px;}
        .action-item button.btn{padding:8px 10px;border-radius:8px;min-width:80px;font-size:0.9rem;}

        /* Event modal container for stacking */
        .event-container{
            position:fixed;
            right:16px;
            bottom:16px;
            display:flex;
            flex-direction:column-reverse;
            gap:10px;
            z-index:1200;
            align-items:flex-end;
            pointer-events:none;
        }
        .event-modal{
            width:360px;
            max-width:95vw;
            background:linear-gradient(180deg,var(--dark), #21324a);
            color:var(--light);
            border-radius:12px;
            padding:12px;
            box-shadow:0 10px 30px rgba(0,0,0,0.5);
            transform:translateY(10px) scale(.98);
            opacity:0;
            transition:all 280ms cubic-bezier(.2,.9,.2,1);
            pointer-events:auto;
            border:1px solid rgba(255,255,255,0.04);
        }
        .event-modal.active{opacity:1;transform:translateY(0) scale(1);}
        .event-modal h4{margin-bottom:8px;}
        .event-modal p{opacity:0.95;font-size:0.95rem;}
        .modal-buttons{display:flex;gap:8px;margin-top:10px;justify-content:flex-end;}
        .event-modal .small-meta{display:flex;justify-content:space-between;opacity:0.9;margin-top:8px;font-size:0.88rem;color:rgba(255,255,255,0.85);}

        /* Floating text */
        .floating-text{
            position:fixed;
            z-index:1400;
            pointer-events:none;
            font-weight:700;
            text-shadow:0 1px 2px rgba(0,0,0,0.5);
            transition:transform 900ms ease-out, opacity 900ms ease-out;
            opacity:1;
        }

        /* Game over / Victory modal (center) */
        .center-modal{
            position:fixed;
            left:50%;
            top:50%;
            transform:translate(-50%,-50%) scale(.98);
            width:600px;
            max-width:95%;
            z-index:1400;
            background:linear-gradient(180deg,#0b1622,#12232e);
            color:var(--light);
            padding:18px;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6);
            opacity:0;pointer-events:none;transition:all 280ms ease;
        }
        .center-modal.active{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1);}

        /* tooltips */
        .tooltip{position:relative;display:inline-block;}
        .tooltip .tooltiptext{
            visibility:hidden;
            width:240px;background:var(--dark);color:#fff;text-align:left;border-radius:8px;padding:10px;
            position:absolute;z-index:999;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .2s;
            box-shadow:0 6px 18px rgba(0,0,0,0.4);font-size:0.88rem;
        }
        .tooltip:hover .tooltiptext{visibility:visible;opacity:1;}

        /* mobile tweaks */
        @media (max-width:768px){
            header{flex-direction:column;align-items:flex-start;padding:12px;}
            .header-controls{width:100%;justify-content:space-between;}
            .dashboard{grid-template-columns:repeat(2,1fr);}
            .action-panel{grid-template-columns:1fr;}
            .event-container{left:8px;right:8px;bottom:8px;align-items:center;}
            .event-modal{width:100%;}
        }

    </style>
</head>
<body>
    <div class="bg-clouds" aria-hidden="true"></div>

    <div class="container">
        <header>
            <div class="title">
                <h1>Country-Building Simulator</h1>
                <p id="header-sub">Build your nation from the ground up! Turn: 1</p>
            </div>

            <div class="header-controls">
                <button id="save-btn" class="btn small ghost" title="Save your current game to your browser">üíæ Save</button>
                <button id="load-btn" class="btn small ghost" title="Load your last saved game">üìÇ Load</button>
                <button id="export-btn" class="btn small ghost" title="Export save as JSON">üîÅ Export</button>
                <button id="import-btn" class="btn small ghost" title="Import save JSON">üì• Import</button>
            </div>
        </header>

        <!-- Continent Selection Phase -->
        <div id="continent-phase" class="game-phase active" aria-live="polite">
            <h2>Choose Your Continent</h2>
            <p>Select a continent. Hover/tap the info for bonuses.</p>

            <div class="selection-grid" id="continent-grid">
                <div class="selection-card" data-continent="africa" role="button" tabindex="0">
                    <div class="card-icon">üåç</div>
                    <h3>Africa <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+50% mineral production, -20% initial infrastructure</span>
                    </span></h3>
                    <p>Rich in mineral resources</p>
                </div>
                <div class="selection-card" data-continent="asia" role="button" tabindex="0">
                    <div class="card-icon">üóæ</div>
                    <h3>Asia <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+30% population growth, +20% tech research speed</span>
                    </span></h3>
                    <p>Large population & tech potential</p>
                </div>
                <div class="selection-card" data-continent="europe" role="button" tabindex="0">
                    <div class="card-icon">üèõÔ∏è</div>
                    <h3>Europe <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+40% initial infrastructure, -10% resource production</span>
                    </span></h3>
                    <p>Advanced infrastructure</p>
                </div>
                <div class="selection-card" data-continent="north-america" role="button" tabindex="0">
                    <div class="card-icon">üóΩ</div>
                    <h3>North America <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+30% money generation, +15% trade efficiency</span>
                    </span></h3>
                    <p>Strong economy</p>
                </div>
                <div class="selection-card" data-continent="south-america" role="button" tabindex="0">
                    <div class="card-icon">üå¥</div>
                    <h3>South America <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+40% food production, +25% natural resources</span>
                    </span></h3>
                    <p>Fertile land & natural resources</p>
                </div>
                <div class="selection-card" data-continent="oceania" role="button" tabindex="0">
                    <div class="card-icon">üèùÔ∏è</div>
                    <h3>Oceania <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+50% stability, +30% diplomatic power</span>
                    </span></h3>
                    <p>High stability & strategic location</p>
                </div>
            </div>

            <div style="text-align:center;margin-top:14px;">
                <button id="next-to-politics" class="btn" disabled>Continue to Political System</button>
            </div>
        </div>

        <!-- Political System Selection Phase -->
        <div id="politics-phase" class="game-phase" aria-live="polite">
            <h2>Choose Your Political System</h2>
            <p>Pick a political system to shape your long-term gameplay.</p>

            <div class="selection-grid" id="politics-grid">
                <div class="selection-card" data-system="capitalist" role="button" tabindex="0">
                    <div class="card-icon">üíº</div>
                    <h3>Capitalist <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+25% money generation, -15% stability</span>
                    </span></h3>
                    <p>Free market economy with private ownership</p>
                </div>
                <div class="selection-card" data-system="socialist" role="button" tabindex="0">
                    <div class="card-icon">‚öñÔ∏è</div>
                    <h3>Socialist <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">+30% stability, -20% economic growth</span>
                    </span></h3>
                    <p>Public ownership with social welfare</p>
                </div>
                <div class="selection-card" data-system="mixed" role="button" tabindex="0">
                    <div class="card-icon">üîÑ</div>
                    <h3>Mixed Economy <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">Balanced bonuses to all stats</span>
                    </span></h3>
                    <p>Balance of private enterprise and government intervention</p>
                </div>
            </div>

            <div style="text-align:center;margin-top:14px;">
                <button id="next-to-game" class="btn" disabled>Start Building Your Nation</button>
            </div>
        </div>

        <!-- Main Game Phase -->
        <div id="game-phase" class="game-phase" aria-live="polite">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
                <h2 style="margin:0">Nation Dashboard</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <div style="opacity:0.95">Turn: <strong id="turn-counter">1</strong></div>
                    <button id="next-turn" class="btn pulse">Next Turn</button>
                </div>
            </div>

            <div class="dashboard">
                <div class="stat-card">
                    <h3>Money</h3>
                    <div class="stat-value" id="money-value">$1000</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="money-bar" style="width:60%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Population</h3>
                    <div class="stat-value" id="population-value">1.2M</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="population-bar" style="width:40%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Technology</h3>
                    <div class="stat-value" id="tech-value">25</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="tech-bar" style="width:25%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Minerals</h3>
                    <div class="stat-value" id="minerals-value">500</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="minerals-bar" style="width:50%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Stability</h3>
                    <div class="stat-value" id="stability-value">75%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="stability-bar" style="width:75%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Influence</h3>
                    <div class="stat-value" id="influence-value">10</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="influence-bar" style="width:10%"></div>
                    </div>
                </div>
            </div>

            <div class="action-panel" id="action-panel">
                <div class="action-card">
                    <h3>Economy</h3>
                    <div class="action-item">
                        <span>Build Factory</span>
                        <button class="btn" data-action="factory">Build <span class="cost" data-action="factory">$500</span></button>
                    </div>
                    <div class="action-item">
                        <span>Develop Infrastructure</span>
                        <button class="btn" data-action="infrastructure">Develop <span class="cost" data-action="infrastructure">$300</span></button>
                    </div>
                    <div class="action-item">
                        <span>Trade Agreement</span>
                        <button class="btn" data-action="trade">Negotiate <span class="cost" data-action="trade">$200</span></button>
                    </div>
                </div>

                <div class="action-card">
                    <h3>Society</h3>
                    <div class="action-item">
                        <span>Education Reform</span>
                        <button class="btn" data-action="education">Reform <span class="cost" data-action="education">$400</span></button>
                    </div>
                    <div class="action-item">
                        <span>Healthcare System</span>
                        <button class="btn" data-action="healthcare">Implement <span class="cost" data-action="healthcare">$600</span></button>
                    </div>
                    <div class="action-item">
                        <span>Social Programs</span>
                        <button class="btn" data-action="social">Fund <span class="cost" data-action="social">$250</span></button>
                    </div>
                </div>

                <div class="action-card">
                    <h3>Technology</h3>
                    <div class="action-item">
                        <span>Research Lab</span>
                        <button class="btn" data-action="research">Build <span class="cost" data-action="research">$800</span></button>
                    </div>
                    <div class="action-item">
                        <span>Tech Education</span>
                        <button class="btn" data-action="techedu">Implement <span class="cost" data-action="techedu">$350</span></button>
                    </div>
                    <div class="action-item">
                        <span>Innovation Fund</span>
                        <button class="btn" data-action="innovation">Create <span class="cost" data-action="innovation">$450</span></button>
                    </div>
                </div>

                <div class="action-card">
                    <h3>Resources</h3>
                    <div class="action-item">
                        <span>Mine Expansion</span>
                        <button class="btn" data-action="mine">Expand <span class="cost" data-action="mine">$400</span></button>
                    </div>
                    <div class="action-item">
                        <span>Agriculture</span>
                        <button class="btn" data-action="agriculture">Develop <span class="cost" data-action="agriculture">$300</span></button>
                    </div>
                    <div class="action-item">
                        <span>Resource Trade</span>
                        <button class="btn" data-action="resourcetrade">Trade <span class="cost" data-action="resourcetrade">$150</span></button>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Event container -> creates stacked event cards -->
    <div class="event-container" id="event-container" aria-live="polite"></div>

    <!-- Centered modals for victory/gameover/summary -->
    <div id="center-modal" class="center-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <h3 id="center-title">Title</h3>
        <p id="center-body">Body</p>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
            <button id="center-close" class="btn">Close</button>
            <button id="center-restart" class="btn secondary">Play Again</button>
        </div>
    </div>

    <script>
        /*****************************************************************************
         * Modular, enhanced game script
         * Features implemented:
         *  - Dynamic scaling costs
         *  - Animated stat changes and floating text
         *  - Smooth progress bar animations
         *  - Event queue & stacking (multiple events shown)
         *  - Save / Load (localStorage + export/import)
         *  - Victory & loss conditions + centered modal
         *  - Mobile & UX improvements
         *  - Modular functions and minimized duplication
         *****************************************************************************/

        // --- Game state (single source of truth)
        const DEFAULT_STATE = {
            continent: null,
            politicalSystem: null,
            money: 1000,
            population: 1200000,
            technology: 25,
            minerals: 500,
            stability: 75,
            influence: 10,
            turn: 1,
            buildings: { factory:0, infrastructure:0, research:0, mine:0 },
            modifiers: { money:1, population:1, technology:1, minerals:1, stability:1, influence:1 },
            // scaledCosts stores the current cost for each action (changes after purchase)
            scaledCosts: {},
            // simple event queue
            eventQueue: []
        };

        let gameState = JSON.parse(JSON.stringify(DEFAULT_STATE));

        // Base costs & scaling
        const BASE_COSTS = {
            factory:500, infrastructure:300, trade:200,
            education:400, healthcare:600, social:250,
            research:800, techedu:350, innovation:450,
            mine:400, agriculture:300, resourcetrade:150
        };
        const COST_SCALE = {
            // multiplicative scale per purchase for actions that can be purchased multiple times
            factory:1.18,
            infrastructure:1.12,
            trade:1.08,
            education:1.15,
            healthcare:1.18,
            social:1.10,
            research:1.2,
            techedu:1.12,
            innovation:1.14,
            mine:1.15,
            agriculture:1.12,
            resourcetrade:1.06
        };

        // continent & political bonuses
        const continentBonuses = {
            africa: { minerals:1.5, infrastructure:0.8 },
            asia: { population:1.3, technology:1.2 },
            europe: { infrastructure:1.4, minerals:0.9 },
            'north-america': { money:1.3, influence:1.15 },
            'south-america': { minerals:1.25, stability:1.1 },
            oceania: { stability:1.5, influence:1.3 }
        };
        const politicalBonuses = {
            capitalist: { money:1.25, stability:0.85 },
            socialist: { stability:1.3, money:0.8 },
            mixed: { money:1.1, stability:1.1, technology:1.05, minerals:1.05 }
        };

        // events & action effects (actionEffects do NOT include purchase cost)
        const events = [
            {
                id:'econ_crisis',
                title:"Economic Crisis",
                description:"A global economic downturn has affected trade and markets worldwide.",
                option1:"Stimulate economy (costly)",
                option2:"Implement austerity",
                effects1:{ money:-200, stability:-5 },
                effects2:{ money:-100, stability:-10, population:-50000 }
            },
            {
                id:'natural_disaster',
                title:"Natural Disaster",
                description:"A major earthquake struck, damaging infrastructure and causing casualties.",
                option1:"Allocate emergency funds",
                option2:"Request international aid",
                effects1:{ money:-300, stability:-5 },
                effects2:{ stability:-10, influence:-2 }
            },
            {
                id:'tech_break',
                title:"Technological Breakthrough",
                description:"Scientists made a significant discovery in renewable energy.",
                option1:"Invest heavily in research",
                option2:"License the tech",
                effects1:{ money:-250, technology:15 },
                effects2:{ money:150, technology:5 }
            },
            {
                id:'diplomatic',
                title:"Diplomatic Opportunity",
                description:"A neighboring country proposes a strategic alliance.",
                option1:"Form the alliance",
                option2:"Remain neutral",
                effects1:{ influence:5, stability:5 },
                effects2:{ influence:-2 }
            },
            {
                id:'resource_discovery',
                title:"Resource Discovery",
                description:"Vast mineral deposits have been discovered.",
                option1:"Invest in extraction",
                option2:"Auction extraction rights",
                effects1:{ money:-200, minerals:300 },
                effects2:{ money:400, minerals:100 }
            }
        ];

        const actionEffects = {
            factory:{ moneyMod:1.1 },
            infrastructure:{ stability:5, population:50000 },
            trade:{ moneyMod:1.05, influence:2 },
            education:{ technology:10, stability:3 },
            healthcare:{ stability:10, population:100000 },
            social:{ stability:8 },
            research:{ technology:25 },
            techedu:{ technology:15 },
            innovation:{ technology:20 },
            mine:{ minerals:200 },
            agriculture:{ population:75000, stability:3 },
            resourcetrade:{ money:300, minerals:-50 }
        };

        // DOM references (cached)
        const DOM = {
            continentPhase: document.getElementById('continent-phase'),
            politicsPhase: document.getElementById('politics-phase'),
            gamePhase: document.getElementById('game-phase'),
            nextToPoliticsBtn: document.getElementById('next-to-politics'),
            nextToGameBtn: document.getElementById('next-to-game'),
            nextTurnBtn: document.getElementById('next-turn'),
            continentCards: document.querySelectorAll('[data-continent]'),
            systemCards: document.querySelectorAll('[data-system]'),
            actionButtons: document.querySelectorAll('[data-action]'),
            costSpans: document.querySelectorAll('.cost[data-action]'),
            eventContainer: document.getElementById('event-container'),
            centerModal: document.getElementById('center-modal'),
            centerTitle: document.getElementById('center-title'),
            centerBody: document.getElementById('center-body'),
            centerClose: document.getElementById('center-close'),
            centerRestart: document.getElementById('center-restart'),
            saveBtn: document.getElementById('save-btn'),
            loadBtn: document.getElementById('load-btn'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            headerSub: document.getElementById('header-sub'),
            turnCounter: document.getElementById('turn-counter'),
            // stat elements
            moneyValue: document.getElementById('money-value'),
            populationValue: document.getElementById('population-value'),
            techValue: document.getElementById('tech-value'),
            mineralsValue: document.getElementById('minerals-value'),
            stabilityValue: document.getElementById('stability-value'),
            influenceValue: document.getElementById('influence-value'),
            moneyBar: document.getElementById('money-bar'),
            populationBar: document.getElementById('population-bar'),
            techBar: document.getElementById('tech-bar'),
            mineralsBar: document.getElementById('minerals-bar'),
            stabilityBar: document.getElementById('stability-bar'),
            influenceBar: document.getElementById('influence-bar')
        };

        // --- Utilities: animations, sounds, floating text
        function formatNumber(n){
            if (Math.abs(n) >= 1000000) return (n/1000000).toFixed(1) + 'M';
            if (Math.abs(n) >= 1000) return (n/1000).toFixed(1) + 'k';
            return n.toString();
        }

        function animateValue(el, start, end, duration = 700, formatter = v => v){
            const startTime = performance.now();
            const range = end - start;
            function step(now){
                const t = Math.min(1, (now - startTime) / duration);
                const eased = t<.5 ? 2*t*t : -1 + (4-2*t)*t; // simple ease
                const val = start + range * eased;
                el.textContent = formatter(Math.round(val));
                if (t < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        function floatText(x, y, text, color = '#fff'){
            // create a floating text element at page coordinates (x,y)
            const ft = document.createElement('div');
            ft.className = 'floating-text';
            ft.style.left = `${x}px`;
            ft.style.top = `${y}px`;
            ft.style.color = color;
            ft.textContent = text;
            document.body.appendChild(ft);
            requestAnimationFrame(()=> {
                ft.style.transform = 'translateY(-60px) scale(1.04)';
                ft.style.opacity = '0';
            });
            setTimeout(()=> ft.remove(), 1000);
        }

        // Simple sound via WebAudio to avoid external assets
        const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
        function playSound(type='click'){
            if (!audioCtx) return;
            try {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = (type === 'success') ? 'sine' : 'triangle';
                o.frequency.value = (type === 'success') ? 880 : 440;
                g.gain.value = 0.02;
                o.connect(g);
                g.connect(audioCtx.destination);
                o.start();
                o.stop(audioCtx.currentTime + 0.08);
            } catch(e){}
        }

        // --- Save / Load functionality
        const STORAGE_KEY = 'stratgaem_save_v1';
        function saveGame(){
            const toSave = JSON.stringify(gameState);
            localStorage.setItem(STORAGE_KEY, toSave);
            showCenterModal('Game Saved', 'Your game has been saved to localStorage.', true);
        }
        function loadGame(){
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw){ showCenterModal('No Save Found', 'No saved game found in localStorage.'); return; }
            try {
                const parsed = JSON.parse(raw);
                gameState = Object.assign({}, DEFAULT_STATE, parsed);
                // ensure scaledCosts exists
                initializeScaledCosts();
                applyBonuses();
                updateUI(true);
                showCenterModal('Game Loaded', 'Save loaded from localStorage.', true);
            } catch(e){
                showCenterModal('Load Error', 'Failed to parse saved game.');
            }
        }
        function exportSave(){
            const data = JSON.stringify(gameState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stratgaem_save.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        function importSave(){
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.addEventListener('change', e=>{
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const parsed = JSON.parse(reader.result);
                        gameState = Object.assign({}, DEFAULT_STATE, parsed);
                        initializeScaledCosts();
                        applyBonuses();
                        updateUI(true);
                        showCenterModal('Imported', 'Save imported successfully.', true);
                    } catch(err){
                        showCenterModal('Import Error', 'Invalid JSON.');
                    }
                };
                reader.readAsText(file);
            });
            input.click();
        }

        // center modal helpers
        function showCenterModal(title, body, autoClose=false){
            DOM.centerTitle.textContent = title;
            DOM.centerBody.textContent = body;
            DOM.centerModal.classList.add('active');
            DOM.centerModal.setAttribute('aria-hidden','false');
            playSound('success');
            if (autoClose) setTimeout(()=> hideCenterModal(), 1300);
        }
        function hideCenterModal(){ DOM.centerModal.classList.remove('active'); DOM.centerModal.setAttribute('aria-hidden','true'); }

        // initialize scaledCosts from base if missing
        function initializeScaledCosts(){
            if (!gameState.scaledCosts || Object.keys(gameState.scaledCosts).length === 0){
                gameState.scaledCosts = {};
                Object.keys(BASE_COSTS).forEach(k => gameState.scaledCosts[k] = BASE_COSTS[k]);
            } else {
                // make sure every key exists
                Object.keys(BASE_COSTS).forEach(k => {
                    if (!(k in gameState.scaledCosts)) gameState.scaledCosts[k] = BASE_COSTS[k];
                });
            }
        }

        // Apply continent & political bonuses to modifiers
        function applyBonuses(){
            Object.keys(gameState.modifiers).forEach(k => gameState.modifiers[k] = 1);
            if (gameState.continent && continentBonuses[gameState.continent]){
                Object.keys(continentBonuses[gameState.continent]).forEach(k=>{
                    gameState.modifiers[k] *= continentBonuses[gameState.continent][k];
                });
            }
            if (gameState.politicalSystem && politicalBonuses[gameState.politicalSystem]){
                Object.keys(politicalBonuses[gameState.politicalSystem]).forEach(k=>{
                    gameState.modifiers[k] *= politicalBonuses[gameState.politicalSystem][k];
                });
            }
        }

        // Update cost display & button enabled state
        function refreshCostsAndButtons(){
            DOM.costSpans.forEach(span=>{
                const act = span.getAttribute('data-action');
                const cost = Math.round(gameState.scaledCosts[act] || BASE_COSTS[act]);
                span.textContent = `$${cost}`;
                // find the parent button
                const btn = document.querySelector(`button[data-action="${act}"]`);
                if (btn) btn.disabled = (gameState.money < cost);
            });
        }

        // Perform an action: deduct cost, apply effects, scale cost, animate
        function performAction(action, evtElement=null){
            const costs = gameState.scaledCosts;
            if (!(action in costs)) return;
            const cost = Math.round(costs[action]);

            if (gameState.money < cost){ showCenterModal('Insufficient Funds', `You need $${cost} to ${action}.`); playSound('click'); return; }

            // Deduct
            const prevMoney = gameState.money;
            gameState.money -= cost;
            animateStatChange('money', prevMoney, gameState.money, evtElement);

            // Apply effects
            const effects = actionEffects[action] || {};
            Object.keys(effects).forEach(key=>{
                if (key.includes('Mod')){
                    const stat = key.replace('Mod','');
                    gameState.modifiers[stat] *= effects[key];
                } else {
                    if (typeof gameState[key] === 'number'){
                        const prev = gameState[key];
                        gameState[key] += effects[key];
                        animateStatChange(key, prev, gameState[key], evtElement);
                    }
                }
            });

            // update buildings if relevant
            if (['factory','infrastructure','research','mine'].includes(action)){
                gameState.buildings[action] = (gameState.buildings[action] || 0) + 1;
            }

            // scale cost up for next purchase
            const scale = COST_SCALE[action] || 1.08;
            gameState.scaledCosts[action] = Math.max(1, Math.round(gameState.scaledCosts[action] * scale));

            // Visual + audio feedback
            playSound('click');
            // Floating text near the button if element provided
            if (evtElement && evtElement instanceof HTMLElement){
                const rect = evtElement.getBoundingClientRect();
                floatText(rect.left + rect.width/2, rect.top, `-$${cost}`, '#f5d36b');
            }

            refreshCostsAndButtons();
            updateUI();
        }

        // Animate stat change and update progress bars
        function animateStatChange(stat, from, to, evtElement=null){
            // map stat to DOM element & bar
            const map = {
                money: {el:DOM.moneyValue, bar:DOM.moneyBar, max:5000, fmt: v => `$${v}`},
                population: {el:DOM.populationValue, bar:DOM.populationBar, max:5000000, fmt: v => `${(v/1000000).toFixed(1)}M`},
                technology: {el:DOM.techValue, bar:DOM.techBar, max:100, fmt: v => `${v}`},
                minerals: {el:DOM.mineralsValue, bar:DOM.mineralsBar, max:1000, fmt: v => `${v}`},
                stability: {el:DOM.stabilityValue, bar:DOM.stabilityBar, max:100, fmt: v => `${v}%`},
                influence: {el:DOM.influenceValue, bar:DOM.influenceBar, max:100, fmt: v => `${v}`}
            };
            const meta = map[stat];
            if (!meta) return;
            animateValue(meta.el, from, to, 700, v => meta.fmt(v));
            // progress bar
            const pct = Math.min(100, (to / meta.max) * 100);
            meta.bar.style.width = `${pct}%`;

            // spawn floating text for delta
            const delta = to - from;
            if (delta !== 0){
                const positive = delta > 0;
                const color = positive ? '#9eedc7' : '#ffb4b4';
                const sign = positive ? '+' : '-';
                // position roughly near stat-value element
                const rect = meta.el.getBoundingClientRect();
                floatText(rect.left + rect.width/2, rect.top, `${sign}${Math.abs(delta)}`, color);
            }
        }

        // Next turn: passive generation, event chance, victory/loss checks
        function nextTurn(){
            // passive income/growth
            const prevMoney = gameState.money;
            gameState.money += Math.floor(100 * gameState.modifiers.money);
            animateStatChange('money', prevMoney, gameState.money);

            const prevPop = gameState.population;
            gameState.population += Math.floor(50000 * gameState.modifiers.population);
            animateStatChange('population', prevPop, gameState.population);

            const prevTech = gameState.technology;
            gameState.technology += Math.floor(2 * gameState.modifiers.technology);
            animateStatChange('technology', prevTech, gameState.technology);

            const prevMinerals = gameState.minerals;
            gameState.minerals += Math.floor(50 * gameState.modifiers.minerals);
            animateStatChange('minerals', prevMinerals, gameState.minerals);

            // multiple event triggers allowed: we allow up to 2 events per turn probabilistically
            let eventsTriggered = 0;
            for (let i=0;i<2;i++){
                if (Math.random() < 0.2){ // 20% per trial => up to two events
                    enqueueRandomEvent();
                    eventsTriggered++;
                }
            }
            if (eventsTriggered) playSound('success');

            // increment turn & UI
            gameState.turn++;
            updateUI();

            // auto-save small snapshot
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); } catch(e){}

            // check victory/loss
            checkVictoryLoss();
        }

        // Enqueue a random event into the event queue and render
        function enqueueRandomEvent(){
            const ev = events[Math.floor(Math.random() * events.length)];
            // create an instance (clone) so handlers refer to right object
            const inst = Object.assign({ uuid: 'ev-' + Date.now() + Math.random().toString(36).slice(2) }, ev);
            gameState.eventQueue.push(inst);
            renderEventQueue();
        }

        // Render stacked event modals
        function renderEventQueue(){
            DOM.eventContainer.innerHTML = ''; // clear
            // show up to 5 stacked events (older ones lower)
            gameState.eventQueue.forEach((ev, idx) => {
                const card = document.createElement('div');
                card.className = 'event-modal active';
                card.style.zIndex = 1100 + idx;
                card.innerHTML = `
                    <h4>${ev.title}</h4>
                    <p>${ev.description}</p>
                    <div class="small-meta">
                        <span>Turn: ${gameState.turn}</span>
                        <span>Event</span>
                    </div>
                    <div class="modal-buttons">
                        <button class="btn small option1"> ${ev.option1} </button>
                        <button class="btn small ghost option2"> ${ev.option2} </button>
                    </div>
                `;
                // option handlers
                const opt1 = card.querySelector('.option1');
                const opt2 = card.querySelector('.option2');
                const removeAndApply = (effects) => {
                    applyEventEffects(effects, card);
                    // remove this event instance from queue
                    gameState.eventQueue = gameState.eventQueue.filter(e => e.uuid !== ev.uuid);
                    renderEventQueue();
                };
                opt1.addEventListener('click', () => removeAndApply(ev.effects1));
                opt2.addEventListener('click', () => removeAndApply(ev.effects2));
                DOM.eventContainer.appendChild(card);
            });
        }

        // Apply event effects (can be called for action responses too)
        function applyEventEffects(effects, sourceElement=null){
            Object.keys(effects).forEach(k=>{
                if (k in gameState){
                    const prev = gameState[k];
                    gameState[k] += effects[k];
                    animateStatChange(k, prev, gameState[k], sourceElement);
                } else {
                    console.warn('Unknown stat in event effect:', k);
                }
            });
            // small feedback sound
            playSound('click');
            updateUI();
        }

        // Check for victory or loss conditions
        function checkVictoryLoss(){
            // Loss conditions
            if (gameState.stability <= 0 || gameState.population <= 0 || gameState.money <= -10000){
                // Game over
                let title, message;
                if (gameState.stability <= 0){ title = 'Revolution!'; message = 'Your government was overthrown due to low stability.'; }
                else if (gameState.population <= 0){ title = 'Population Collapse'; message = 'Your nation lost its population.'; }
                else { title = 'Bankruptcy'; message = 'Your nation defaulted on debts.'; }
                showCenterModal(title, message);
                DOM.centerRestart.addEventListener('click', resetGameOnce);
                DOM.centerClose.addEventListener('click', () => { hideCenterModal(); resetGameOnce(); });
                return;
            }

            // Victory conditions (at least one threshold)
            const win = (gameState.population >= 10000000) || (gameState.technology >= 200) || (gameState.influence >= 200);
            if (win){
                const summary = `Turns: ${gameState.turn}\nPopulation: ${formatNumber(gameState.population)}\nTech: ${gameState.technology}\nInfluence: ${gameState.influence}`;
                showCenterModal('Victory!', 'You achieved a major national milestone! ' + '\n\n' + summary);
                DOM.centerRestart.addEventListener('click', resetGameOnce);
                DOM.centerClose.addEventListener('click', hideCenterModal);
            }
        }

        // Ensure reset handler only attached once
        function resetGameOnce(){
            gameState = JSON.parse(JSON.stringify(DEFAULT_STATE));
            initializeScaledCosts();
            applyBonuses();
            updateUI(true);
            hideCenterModal();
            playSound('success');
        }

        // Update UI: refresh numbers and costs, header
        function updateUI(skipAnimate = false){
            DOM.headerSub.textContent = `Build your nation from the ground up! Turn: ${gameState.turn}`;
            DOM.turnCounter.textContent = gameState.turn;

            // set stat displays (use immediate set if skipAnimate true)
            if (skipAnimate){
                DOM.moneyValue.textContent = `$${gameState.money}`;
                DOM.populationValue.textContent = `${(gameState.population/1000000).toFixed(1)}M`;
                DOM.techValue.textContent = gameState.technology;
                DOM.mineralsValue.textContent = gameState.minerals;
                DOM.stabilityValue.textContent = `${gameState.stability}%`;
                DOM.influenceValue.textContent = gameState.influence;

                DOM.moneyBar.style.width = `${Math.min(100, (gameState.money/5000)*100)}%`;
                DOM.populationBar.style.width = `${Math.min(100, (gameState.population/5000000)*100)}%`;
                DOM.techBar.style.width = `${Math.min(100, gameState.technology)}%`;
                DOM.mineralsBar.style.width = `${Math.min(100, (gameState.minerals/1000)*100)}%`;
                DOM.stabilityBar.style.width = `${Math.min(100, gameState.stability)}%`;
                DOM.influenceBar.style.width = `${Math.min(100, gameState.influence)}%`;
            } else {
                // animate small changes by calling animateStatChange with current values as both start & end (to sync)
                animateStatChange('money', gameState.money, gameState.money);
                animateStatChange('population', gameState.population, gameState.population);
                animateStatChange('technology', gameState.technology, gameState.technology);
                animateStatChange('minerals', gameState.minerals, gameState.minerals);
                animateStatChange('stability', gameState.stability, gameState.stability);
                animateStatChange('influence', gameState.influence, gameState.influence);
            }

            refreshCostsAndButtons();
            renderEventQueue();
        }

        // --- Initialization: set up scaled costs and event listeners
        function init(){
            initializeScaledCosts();

            // continent selection
            DOM.continentCards.forEach(card=>{
                card.addEventListener('click', ()=>{
                    DOM.continentCards.forEach(c=>c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.continent = card.getAttribute('data-continent');
                    DOM.nextToPoliticsBtn.disabled = false;
                    playSound('click');
                });
                // keyboard accessibility
                card.addEventListener('keydown', (e)=> { if (e.key === 'Enter') card.click(); });
            });

            DOM.nextToPoliticsBtn.addEventListener('click', ()=> {
                DOM.continentPhase.classList.remove('active');
                DOM.politicsPhase.classList.add('active');
            });

            // political selection
            DOM.systemCards.forEach(card=>{
                card.addEventListener('click', ()=>{
                    DOM.systemCards.forEach(c=>c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.politicalSystem = card.getAttribute('data-system');
                    DOM.nextToGameBtn.disabled = false;
                    playSound('click');
                });
                card.addEventListener('keydown', (e)=> { if (e.key === 'Enter') card.click(); });
            });

            DOM.nextToGameBtn.addEventListener('click', ()=>{
                DOM.politicsPhase.classList.remove('active');
                DOM.gamePhase.classList.add('active');
                applyBonuses();
                updateUI(true);
            });

            // action buttons
            DOM.actionButtons.forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                    const action = btn.getAttribute('data-action');
                    performAction(action, btn);
                });
            });

            // next turn
            DOM.nextTurnBtn.addEventListener('click', nextTurn);

            // center modal controls
            DOM.centerClose.addEventListener('click', hideCenterModal);
            DOM.centerRestart.addEventListener('click', resetGameOnce);

            // save/load/export/import
            DOM.saveBtn.addEventListener('click', saveGame);
            DOM.loadBtn.addEventListener('click', loadGame);
            DOM.exportBtn.addEventListener('click', exportSave);
            DOM.importBtn.addEventListener('click', importSave);

            // keyboard shortcut: S to save, L to load
            window.addEventListener('keydown', (e)=>{
                if (e.key.toLowerCase() === 's' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); saveGame(); }
                if (e.key.toLowerCase() === 'l' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); loadGame(); }
            });

            updateUI(true);
        }

        // run init on load
        init();

        // expose small helpers for debugging (optional)
        window.__game = {
            getState: ()=>gameState,
            save: saveGame,
            load: loadGame,
            reset: resetGameOnce
        };

    </script>
</body>
</html>
